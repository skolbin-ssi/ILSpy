platform: Any CPU

configuration:
- Debug
- Release

image: Visual Studio 2019

init:
# force git to use crlf: otherwise dotnet-format --check fails
- git config --global core.autocrlf true

install:
- git submodule update --init --recursive
- pwsh .\BuildTools\appveyor-install.ps1
- dotnet tool install dotnet-format --tool-path BuildTools --version 4.1.131201

nuget:
  account_feed: false
  project_feed: true
  disable_publish_on_pr: true

before_build:
- nuget restore ILSpy.sln

build_script:
- msbuild ILSpy.sln /v:minimal /p:ResolveNuGetPackages=false "/logger:%ProgramFiles%\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"

after_build:
- 7z a ILSpy_binaries.zip %APPVEYOR_BUILD_FOLDER%\ILSpy\bin\%configuration%\net472\*.dll %APPVEYOR_BUILD_FOLDER%\ILSpy\bin\%configuration%\net472\*.exe %APPVEYOR_BUILD_FOLDER%\ILSpy\bin\%configuration%\net472\*.config %APPVEYOR_BUILD_FOLDER%\ILSpy\bin\%configuration%\net472\*\ILSpy.resources.dll %APPVEYOR_BUILD_FOLDER%\ILSpy\bin\%configuration%\net472\*\ILSpy.ReadyToRun.Plugin.resources.dll

test_script:
- vstest.console.exe /logger:Appveyor /Parallel "ICSharpCode.Decompiler.Tests\bin\%configuration%\net472\ICSharpCode.Decompiler.Tests.exe" "ILSpy.Tests\bin\%configuration%\net472\ILSpy.Tests.exe" "ILSpy.BamlDecompiler.Tests\bin\%configuration%\net472\ILSpy.BamlDecompiler.Tests.exe"

after_test:
- python BuildTools\tidy.py
- .\BuildTools\dotnet-format --check --verbosity diagnostic ILSpy.sln

for:
- branches:
    except:
      - master
  artifacts:
    #nothing
- branches:
    only:
      - master
      - /release\/*/
  artifacts:
    - path: ILSpy_binaries.zip
      name: ILSpy %APPVEYOR_REPO_BRANCH% %ILSPY_VERSION_NUMBER% binaries
    - path: '**\*.vsix'
      name: ILSpy AddIn for Visual Studio
    - path: '**\*.nupkg'
      name: ICSharpCode.Decompiler %APPVEYOR_REPO_BRANCH% %ILSPY_VERSION_NUMBER% NuGet
